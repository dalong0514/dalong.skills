<!-- 此文件由机器翻译自 consensus_peaks.md -->

# 共识高峰：宇宙构建

## 概述

Geniml 提供了构建基因组“宇宙”的工具——来自 BED 文件集合的共识峰的标准化参考集。这些宇宙代表基因组区域，其中分析的数据集显示出显着的覆盖重叠，充当标记化和分析的参考词汇表。

## 何时使用

在以下情况下使用共识峰创建：
- 从多个实验中构建参考峰集
- 为 Region2Vec 或 BEDspace 标记化创建 Universe 文件
- 跨数据集集合的基因组区域标准化
- 定义具有统计显着性的感兴趣区域

## 工作流程

### 第 1 步：合并 BED 文件

将所有 BED 文件合并为一个组合文件：

```bash
cat /path/to/bed/files/*.bed > combined_files.bed
```

### 第 2 步：生成覆盖曲目

使用带有平滑窗口的 uniwig 创建 bigWig 覆盖轨迹：

<<<代码块_1>>>

**参数：**
- `-m 25`：平滑窗口大小（染色质可及性通常为 25bp）
- `chrom.sizes`：基因组的染色体大小文件
- `coverage/`：bigWig 文件的输出目录

平滑窗口有助于减少噪声并创建更稳健的峰值边界。

### 第 3 步：构建宇宙

使用四种方法之一构建共识峰：

## 宇宙构建方法

### 1. 覆盖范围截止 (CC)

使用固定覆盖阈值的最简单方法：

<<<代码块_2>>>

**参数：**
- `--cutoff`：覆盖阈值（1 = 并集；文件计数 = 交集）
- `--merge`：合并相邻峰的距离 (bp)
- `--filter-size`：包含的最小峰大小 (bp)

**在以下情况下使用：** 简单的基于阈值的选择就足够了

### 2. 灵活覆盖范围截止 (CCF)

创建围绕边界和区域核心的似然截断的置信区间：

<<<代码块_3>>>

**附加参数：**
- `--confidence`：灵活边界的置信度 (0-1)

**使用时：** 应捕获峰边界的不确定性

### 3.最大似然（ML）

构建考虑区域开始/结束位置的概率模型：

<<<代码块_4>>>

**参数：**
- `--model-type`：似然估计分布（高斯、泊松）

**在以下情况下使用：** 峰值位置的统计建模很重要

### 4.隐马尔可夫模型（HMM）

将基因组区域建模为隐藏状态，并将覆盖范围作为发射：

<<<代码块_5>>>

**参数：**
- `--states`：HMM 隐藏状态的数量（通常为 2-5）

**使用时：** 应捕获基因组状态的复杂模式

## Python API

<<<代码块_6>>>

## 方法比较

|方法|复杂性 |灵活性 |计算成本|最适合 |
|--------|------------|-------------|--------------------|----------|
|抄送 |低|低|低|快速参考集|
| CCF |中等|中等|中等|边界不确定性 |
|机器学习 |高|高|高|统计严谨性|
|嗯|高|高|非常高 |复杂图案|

## 最佳实践

### 选择方法

1. **从 CC 开始**：快速且可解释的初步探索
2. **使用CCF**：当峰边界不确定或有噪声时
3. **应用机器学习**：用于出版物质量的统计分析
4. **部署 HMM**：对复杂染色质状态进行建模时

### 参数选择

**覆盖范围截止：**
- `cutoff = 1`：所有峰值的并集（最宽松）
- `cutoff = n_files`：交集（最严格）
- `cutoff = 0.5 * n_files`：中等共识（典型选择）

**合并距离：**
- ATAC-seq：100-200bp
- ChIP-seq（窄峰）：50-100bp
- ChIP-seq（宽峰）：500-1000bp

**过滤器尺寸：**
- 最小 30bp 以避免伪影
- 大多数检测的典型值为 50-100bp
- 较大的组蛋白标记

### 质量控制

构建后，评估宇宙质量：

```python
from geniml.evaluation import assess_universe

metrics = assess_universe(
    universe_file='universe.bed',
    coverage_folder='coverage/',
    bed_files='bed_files/'
)

print(f"Number of regions: {metrics['n_regions']}")
print(f"Mean region size: {metrics['mean_size']:.1f}bp")
print(f"Coverage of input peaks: {metrics['coverage']:.1%}")
```

**关键指标：**
- **区域计数**：应捕获主要特征，而不会出现过多碎片
- **大小分布**：应符合预期的生物学特性（例如 ATAC-seq 约为 500bp）
- **输入覆盖率**：所代表的原始峰的比例（通常> 80％）

## 输出格式

共有峰保存为 BED 文件，其中包含三个必需列：

```
chr1    1000    1500
chr1    2000    2800
chr2    500     1000
```

其他列可能包括置信度分数或状态注释，具体取决于方法。

## 常见工作流程

### 对于 Region2Vec

1. 使用首选方法构建 Universe
2.使用universe作为标记化参考
3. 标记 BED 文件
4. 训练Region2Vec模型

### 对于床空间
1. 从所有数据集构建 Universe
2.在预处理步骤中使用universe
3. 使用元数据训练 BEDspace
4、跨区域、跨标签查询

### 对于 scEmbed

1. 从批量或聚合的 scATAC-seq 创建 Universe
2. 用于单元标记化
3. 训练 scEmbed 模型
4. 生成单元嵌入

## 故障排除

**区域太少：** 降低截止阈值或减小滤波器尺寸

**区域太多：** 提高截止阈值、增加合并距离或增加过滤器大小

**噪声边界：**使用 CCF 或 ML 方法而不是 CC

**长计算：** 从 CC 方法开始以获得快速结果，然后根据需要使用 ML/HMM 进行细化