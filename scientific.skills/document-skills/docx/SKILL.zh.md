<!-- 此文件由机器翻译自 SKILL.md -->

---
名称：.docx
描述：“文档工具包 (.docx)。创建/编辑文档、跟踪更改、注释、格式保存、文本提取，用于专业文档处理。”
许可证：专有。 LICENSE.txt 有完整的条款
---

# DOCX 创建、编辑和分析

## 概述

.docx 文件是包含 XML 文件和资源的 ZIP 存档。使用文本提取、原始 XML 访问或红线工作流程创建、编辑或分析 Word 文档。将此技能应用于专业文档处理、跟踪更改和内容操作。

## 工作流决策树

### 阅读/分析内容
使用下面的“文本提取”或“原始 XML 访问”部分

### 创建新文档
使用“创建新的 Word 文档”工作流程

### 编辑现有文档
- **您自己的文档+简单的更改**
  使用“基本 OOXML 编辑”工作流程

- **别人的文件**
  使用**“红线工作流程”**（推荐默认值）

- **法律、学术、商业或政府文件**
  使用**“红线工作流程”**（必填）

## 阅读并分析内容

### 文本提取
要读取文档的文本内容，请使用 pandoc 将文档转换为 Markdown。 Pandoc 为保留文档结构提供了出色的支持，并且可以显示跟踪的更改：

```bash
# Convert document to markdown with tracked changes
pandoc --track-changes=all path-to-file.docx -o output.md
# Options: --track-changes=accept/reject/all
```

### 原始 XML 访问
需要原始 XML 访问：注释、复杂格式、文档结构、嵌入媒体和元数据。对于任何这些功能，请解压缩文档并读取其原始 XML 内容。

#### 解压文件
`python ooxml/scripts/unpack.py <office_file> <output_directory>`

#### 关键文件结构
* `word/document.xml` - 主要文档内容
* `word/comments.xml` - document.xml 中引用的注释
* `word/media/` - 嵌入图像和媒体文件
* 跟踪更改使用 `<w:ins>`（插入）和 `<w:del>`（删除）标签

## 创建一个新的Word文档

从头开始创建新的 Word 文档时，请使用 **docx-js**，它允许您使用 JavaScript/TypeScript 创建 Word 文档。

### 工作流程
1. **强制 - 读取整个文件**：从头到尾完整阅读 [`docx-js.md`](docx-js.md)（约 500 行）。 **阅读此文件时切勿设置任何范围限制。** 在继续创建文档之前，请阅读完整的文件内容以了解详细语法、关键格式规则和最佳实践。
2.使用Document、Paragraph、TextRun组件创建JavaScript/TypeScript文件（您可以假设所有依赖项都已安装，但如果没有，请参阅下面的依赖项部分）
3. 使用 Packer.toBuffer() 导出为 .docx

## 编辑现有的Word文档

编辑现有 Word 文档时，请使用 **文档库**（用于 OOXML 操作的 Python 库）。该库自动处理基础设施设置并提供文档操作方法。对于复杂的场景，可以直接通过库访问底层DOM。

### 工作流程
1. **强制 - 读取整个文件**：从头到尾完整读取 [`ooxml.md`](ooxml.md)（约 600 行）。 **读取此文件时切勿设置任何范围限制。** 读取文档库 API 和 XML 模式的完整文件内容，以便直接编辑文档文件。
2. 解压文档：`python ooxml/scripts/unpack.py <office_file> <output_directory>`
3. 使用文档库创建并运行 Python 脚本（请参阅 ooxml.md 中的“文档库”部分）
4.打包最终文件：`python ooxml/scripts/pack.py <input_directory> <office_file>`

Document 库既提供了用于常见操作的高级方法，也提供了用于复杂场景的直接 DOM 访问。

## 修订文档审查工作流程

此工作流程允许在以 OOXML 实现之前使用 Markdown 计划全面的跟踪更改。 **关键**：对于完整的跟踪变更，系统地实施所有变更。

**批处理策略**：将相关更改分组为 3-10 个更改的批次。这使得调试易于管理，同时保持效率。在进行下一批之前测试每一批。

**原则：最少、精确的编辑**
实施跟踪更改时，仅标记实际更改的文本。重复未更改的文本会使编辑更难以审核，并且显得不专业。将替换内容分解为：[未更改的文本] + [删除] + [插入] + [未更改的文本]。通过从原始文本中提取 `<w:r>` 元素并重用它，保留原始运行的 RSID 以保持未更改的文本。

示例 - 将句子中的“30 天”更改为“60 天”：
<<<代码块_1>>>

### 跟踪变更工作流程
1. **获取 Markdown 表示**：将文档转换为 Markdown，并保留跟踪更改：
   <<<代码块_2>>>

2. **识别和分组更改**：查看文档并识别所需的所有更改，将它们组织成逻辑批次：

   **定位方法**（用于查找 XML 中的更改）：
   - 章节/标题编号（例如“第 3.2 节”、“第 IV 条”）
   - 段落标识符（如果编号）
   - 具有独特周围文本的 Grep 模式
   - 文件结构（例如“第一段”、“签名块”）
   - **不要使用 Markdown 行号** - 它们不映射到 XML 结构

   **批次组织**（每批次 3-10 组相关更改）：
   - 按部分：“第 1 批：第 2 条修订”、“第 2 批：第 5 条更新”
   - 按类型：“第 1 批：日期更正”、“第 2 批：当事人名称变更”
   - 按复杂性：从简单的文本替换开始，然后处理复杂的结构变化
   - 顺序：“第 1 批：第 1-3 页”、“第 2 批：第 4-6 页”

3. **阅读文档并解压**：
   - **强制 - 读取整个文件**：从头到尾完整读取 [`ooxml.md`](ooxml.md)（约 600 行）。 **阅读此文件时切勿设置任何范围限制。** 请特别注意“文档库”和“跟踪更改模式”部分。
   - **解压文档**：`python ooxml/scripts/unpack.py <file.docx> <dir>`
   - **注意建议的 RSID**：解包脚本将建议一个 RSID 以用于您跟踪的更改。复制此 RSID 以在步骤 4b 中使用。

4. **批量实施更改**：按逻辑对更改进行分组（按部分、按类型或按邻近度），并在单个脚本中将它们一起实施。这种方法：
   - 使调试更容易（更小的批量 = 更容易隔离错误）
   - 允许渐进式进步
   - 保持效率（批量大小为 3-10 次更改效果很好）

   **建议的批次分组：**
   - 按文件部分（例如“第 3 节变更”、“定义”、“终止条款”）
   - 按变更类型（例如“日期变更”、“当事人名称更新”、“法律术语替换”）
   - 按邻近程度（例如，“第 1-3 页的更改”、“文档前半部分的更改”）

   对于每批相关变更：

   **a.将文本映射到 XML**：Grep 查找 `word/document.xml` 中的文本，以验证文本如何在 `<w:r>` 元素之间拆分。

   **b。创建并运行脚本**：使用 `get_node` 查找节点，实施更改，然后使用 `doc.save()`。有关模式，请参阅 ooxml.md 中的 **“文档库”** 部分。

   **注意**：在编写脚本之前始终 grep `word/document.xml` 来获取当前行号并验证文本内容。每个脚本运行后行号都会发生变化。

5. **打包文档**：所有批次完成后，将解压后的目录转换回.docx：
   <<<代码块_3>>>

6. **最终验证**：对完整文件进行全面检查：
   - 将最终文档转换为 Markdown：
     <<<代码块_4>>>
   - 验证所有更改均已正确应用：
     <<<代码块_5>>>
   - 检查是否引入了意外的更改


## 将文档转换为图像

要直观地分析 Word 文档，请使用两步过程将其转换为图像：

1. **将 DOCX 转换为 PDF**：
   <<<代码块_6>>>

2. **将 PDF 页面转换为 JPEG 图像**：
   ```bash
   pdftoppm -jpeg -r 150 document.pdf page
   ```
   这将创建诸如 `page-1.jpg`、`page-2.jpg` 等文件。

选项：
- `-r 150`：将分辨率设置为 150 DPI（调整质量/尺寸平衡）
- `-jpeg`：输出 JPEG 格式（如果愿意，请使用 `-png` 作为 PNG）
- `-f N`：要转换的第一页（例如，`-f 2` 从第 2 页开始）
- `-l N`：要转换的最后一页（例如，`-l 5` 在第 5 页停止）
- `page`：输出文件的前缀

具体范围示例：
```bash
pdftoppm -jpeg -r 150 -f 2 -l 5 document.pdf page  # Converts only pages 2-5
```

## 代码风格指南
**重要**：生成 DOCX 操作代码时：
- 编写简洁的代码
- 避免冗长的变量名称和冗余操作
- 避免不必要的打印语句

## 依赖关系

所需的依赖项（如果不可用则安装）：

- **pandoc**：`sudo apt-get install pandoc`（用于文本提取）
- **docx**：`npm install -g docx`（用于创建新文档）
- **LibreOffice**：`sudo apt-get install libreoffice`（用于 PDF 转换）
- **Poppler**：`sudo apt-get install poppler-utils`（用于 pdftoppm 将 PDF 转换为图像）
- **defusedxml**：`uv pip install defusedxml`（用于安全 XML 解析）