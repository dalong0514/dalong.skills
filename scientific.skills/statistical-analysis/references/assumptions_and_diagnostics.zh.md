<!-- 此文件由机器翻译自 assumptions_and_diagnostics.md -->

# 统计假设和诊断程序

本文件提供了有关检查和验证各种分析的统计假设的全面指导。

## 一般原则

1. **在解释测试结果之前始终检查假设**
2. **使用多种诊断方法**（目视+正式测试）
3. **考虑稳健性**：某些测试在某些条件下对于违规行为具有稳健性
4. **在分析报告中记录所有假设检查**
5. **报告违规行为并采取补救措施**

## 测试中的常见假设

### 1. 观察的独立性

**含义**：每次观察都是独立的；对一个对象的测量不会影响对另一对象的测量。

**如何检查**：
- 审查研究设计和数据收集程序
- 对于时间序列：检查自相关（ACF/PACF 图、Durbin-Watson 检验）
- 对于聚类数据：考虑类内相关性 (ICC)

**如果违反怎么办**：
- 对集群/分层数据使用混合效应模型
- 对时间相关的数据使用时间序列方法
- 对相关数据使用广义估计方程（GEE）

**严重严重性**：高 - 违规可能会严重加剧 I 类错误

---

### 2. 常态

**含义**：数据或残差服从正态（高斯）分布。

**需要时**：
- t 检验（适用于小样本；每组 n > 30 时稳健）
- 方差分析（适用于小样本；每组 n > 30 时稳健）
- 线性回归（残差）
- 一些相关性测试（皮尔逊）

**如何检查**：

**视觉方法**（主要）：
- Q-Q（分位数-分位数）图：点应落在对角线上
- 带有正态曲线叠加的直方图
- 核密度图

**正式测试**（次要）：
- Shapiro-Wilk 检验（建议 n < 50）
- 柯尔莫哥洛夫-斯米尔诺夫检验
- 安德森-达林测试

**Python 实现**：
```python
from scipy import stats
import matplotlib.pyplot as plt

# Shapiro-Wilk test
statistic, p_value = stats.shapiro(data)

# Q-Q plot
stats.probplot(data, dist="norm", plot=plt)
```

**解读指导**：
- 对于 n < 30：视觉和形式测试都很重要
- 对于 30 ≤ n < 100：目视检查为主，形式测试为次要
- 对于 n ≥ 100：正式测试过于敏感；依靠目视检查
- 寻找严重偏度、异常值或双峰性

**如果违反怎么办**：
- **轻度违规**（轻微偏斜）：如果每组 n > 30，则继续
- **中度违规**：使用非参数替代方案（Mann-Whitney、Kruskal-Wallis、Wilcoxon）
- **严重违规**：
  - 转换数据（对数、平方根、Box-Cox）
  - 使用非参数方法
  - 使用稳健的回归方法
  - 考虑引导

**严重程度**：中 - 参数测试通常对于样本量足够的轻度违规具有稳健性

---

### 3. 方差齐性（Homoscedasticity）

**含义**：组间或预测变量范围内的方差相等。

**需要时**：
- 独立样本t检验
- 方差分析
- 线性回归（残差恒定方差）

**如何检查**：

**视觉方法**（主要）：
- 按组划分的箱线图（用于 t 检验/方差分析）
- 残差与拟合值图（用于回归） - 应显示随机散点
- 尺度位置图（标准化残差与拟合的平方根）

**正式测试**（次要）：
- Levene 检验（对非正态性具有鲁棒性）
- Bartlett 检验（对非正态性敏感，不推荐）
- Brown-Forsythe 检验（Levene 的基于中值的版本）
- Breusch-Pagan 测试（用于回归）

**Python 实现**：
<<<代码块_1>>>

**解读指导**：
- 方差比（最大/最小）< 2-3：一般可接受
- 对于方差分析：如果组大小相等，则测试是稳健的
- 对于回归：在残差图中寻找漏斗模式

**如果违反怎么办**：
- **t 检验**：使用 Welch 的 t 检验（不假设方差相等）
- **方差分析**：使用 Welch 方差分析或 Brown-Forsythe 方差分析
- **回归**：
  - 变换因变量（对数、平方根）
  - 使用加权最小二乘法 (WLS)
  - 使用稳健的标准误差 (HC3)
  - 使用具有适当方差函数的广义线性模型 (GLM)

**严重程度**：中 - 在样本量相同的情况下测试可以很稳健

---

## 特定于测试的假设

### T 测试

**假设**：
1. 观察的独立性
2.正态性（每组进行独立t检验；差异进行配对t检验）
3. 方差齐性（仅限独立 t 检验）

**诊断工作流程**：
<<<代码块_2>>>

---

### 方差分析

**假设**：
1.组内和组间观察的独立性
2.各组的正态性
3. 组间方差的同质性
**其他注意事项**：
- 对于重复测量方差分析：球形假设（莫奇利检验）

**诊断工作流程**：
<<<代码块_3>>>

**如果违反球形度该怎么办**（重复措施）：
- Greenhouse-Geisser 校正 (ε < 0.75)
- Huynh-Feldt 校正 (ε > 0.75)
- 使用多元方法（MANOVA）

---

### 线性回归

**假设**：
1. **线性**：X和Y之间的关系是线性的
2. **独立性**：残差是独立的
3. **同方差性**：残差的恒定方差
4. **正态性**：残差呈正态分布
5. **无多重共线性**：预测变量不高度相关（多元回归）

**诊断工作流程**：

**1.线性**：
<<<代码块_4>>>

**2.独立性**：
<<<代码块_5>>>

**3.同方差性**：
<<<代码块_6>>>

**4.残差的正态性**：
```python
# Q-Q plot of residuals
stats.probplot(residuals, dist="norm", plot=plt)

# Shapiro-Wilk test
stats.shapiro(residuals)
```

**5.多重共线性**：
```python
from statsmodels.stats.outliers_influence import variance_inflation_factor

# Calculate VIF for each predictor
vif_data = pd.DataFrame()
vif_data["feature"] = X.columns
vif_data["VIF"] = [variance_inflation_factor(X.values, i) for i in range(len(X.columns))]

# VIF > 10 indicates severe multicollinearity
# VIF > 5 indicates moderate multicollinearity
```

**如果违反怎么办**：
- **非线性**：添加多项式项、使用 GAM 或变换变量
- **异方差**：变换 Y，使用 WLS，使用稳健的 SE
- **非正态残差**：变换 Y，使用稳健方法，检查异常值
- **多重共线性**：删除相关预测变量，使用 PCA、岭回归

---

### 逻辑回归

**假设**：
1. **独立性**：观察是独立的
2. **线性**：对数赔率和连续预测变量之间的线性关系
3. **不存在完美的多重共线性**：预测变量不完全相关
4. **大样本量**：每个预测因子至少 10-20 个事件

**诊断工作流程**：

**1. logit 的线性**：
```python
# Box-Tidwell test: Add interaction with log of continuous predictor
# If interaction is significant, linearity violated
```

**2.多重共线性**：
```python
# Use VIF as in linear regression
```

**3.有影响力的观察**：
```python
# Cook's distance, DFBetas, leverage
from statsmodels.stats.outliers_influence import OLSInfluence

influence = OLSInfluence(model)
cooks_d = influence.cooks_distance
```

**4.模型拟合**：
```python
# Hosmer-Lemeshow test
# Pseudo R-squared
# Classification metrics (accuracy, AUC-ROC)
```

---

## 异常值检测

**方法**：
1. **视觉**：箱线图、散点图
2. **统计**：
   - Z 分数：|z| > 3 表示异常值
   - IQR 方法：值 < Q1 - 1.5×IQR 或 > Q3 + 1.5×IQR
   - 使用中值绝对偏差修改 Z 分数（对异常值具有鲁棒性）

**对于回归**：
- **杠杆**：高杠杆点（帽子值）
- **影响力**：库克距离 > 4/n 表明有影响力点
- **异常值**：学生化残差 > ±3

**做什么**：
1. 调查数据输入错误
2. 考虑异常值是否是有效的观察值
3. 报告敏感性分析（有异常值和无异常值的结果）
4. 如果异常值合法，则使用稳健的方法

---

## 样本大小注意事项

### 最小样本量（经验法则）

- **T 检验**：每组 n ≥ 30，以保证非正态性的稳健性
- **方差分析**：每组 n ≥ 30
- **相关性**：n ≥ 30 以获得足够的功率
- **简单回归**：n ≥ 50
- **多元回归**：每个预测变量 n ≥ 10-20（最少 10 + k 个预测变量）
- **逻辑回归**：每个预测因子 n ≥ 10-20 个事件

### 小样本注意事项

对于小样本：
- 假设变得更加关键
- 可用时使用精确检验（Fisher 精确、精确逻辑回归）
- 考虑非参数替代方案
- 使用排列测试或引导方法
- 解释要保守

---

## 报告假设检查

报告分析时，请包括：

1. **已检查的假设声明**：列出所有测试的假设
2. **使用的方法**：描述所使用的视觉和形式测试
3. **诊断测试结果**：报告测试统计数据和 p 值
4. **评估**：说明是否满足或违反假设
5. **采取的措施**：如果违反，请描述补救措施（转换、替代测试、稳健方法）

**报告声明示例**：
> “使用 Shapiro-Wilk 检验和 Q-Q 图评估正态性。A 组 (W = 0.97, p = .18) 和 B 组 (W = 0.96, p = .12) 的数据没有显示出显着偏离正态性。使用 Levene 检验评估方差同质性，该检验不显着 (F(1, 58) = 1.23, p = .27)，表明相等因此，独立样本 t 检验的假设得到满足。”