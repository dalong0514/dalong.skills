<!-- 此文件由机器翻译自 SKILL.md -->

---
名称： 皮萨姆
描述：“基因组文件工具包。读/写 SAM/BAM/CRAM 比对、VCF/BCF 变体、FASTA/FASTQ 序列、提取区域、计算覆盖率，用于 NGS 数据处理流程。”
---

# 皮萨姆

## 概述

Pysam 是一个用于读取、操作和写入基因组数据集的 Python 模块。使用 htslib 的 Pythonic 接口读取/写入 SAM/BAM/CRAM 比对文件、VCF/BCF 变体文件和 FASTA/FASTQ 序列。查询 tabix 索引文件，执行覆盖率的堆积分析，并执行 samtools/bcftools 命令。

## 何时使用此技能

该技能应该在以下情况下使用：
- 使用测序比对文件（BAM/CRAM）
- 分析遗传变异（VCF/BCF）
- 提取参考序列或基因区域
- 处理原始测序数据（FASTQ）
- 计算覆盖率或读取深度
- 实施生物信息学分析流程
- 测序数据的质量控制
- 变体调用和注释工作流程

## 快速入门

### 安装
```bash
uv pip install pysam
```

### 基本示例

**读取对齐文件：**
<<<代码块_1>>>

**读取变体文件：**
<<<代码块_2>>>

**查询参考序列：**
<<<代码块_3>>>

## 核心能力

### 1. 对齐文件操作（SAM/BAM/CRAM）

使用 `AlignmentFile` 类来处理对齐的测序读取。这适用于分析绘图结果、计算覆盖率、提取读数或质量控制。

**常用操作：**
- 打开并读取BAM/SAM/CRAM文件
- 从特定基因组区域获取读数
- 通过映射质量、标志或其他标准过滤读数
- 写入过滤或修改的对齐方式
- 计算覆盖率统计数据
- 执行堆积分析（逐个碱基覆盖）
- 访问读取序列、质量分数和比对信息

**参考：** 请参阅 `references/alignment_files.md` 了解有关以下内容的详细文档：
- 打开并读取对齐文件
- AlignedSegment 属性和方法
- 使用 `fetch()` 基于区域的获取
- 覆盖范围的堆积分析
- 编写和创建 BAM 文件
- 坐标系和索引
- 性能优化技巧

### 2. 变体文件操作（VCF/BCF）

使用 `VariantFile` 类处理来自变体调用管道的遗传变体。这适用于变异分析、过滤、注释或群体遗传学。

**常用操作：**
- 读写VCF/BCF文件
- 查询特定地区的变体
- 访问变异信息（位置、等位基因、质量）
- 提取样本的基因型数据
- 按质量、等位基因频率或其他标准过滤变体
- 使用附加信息注释变体
- 样本或区域子集

**参考：** 请参阅 `references/variant_files.md` 了解有关以下内容的详细文档：
- 打开和读取变体文件
- VariantRecord 属性和方法
- 访问信息和格式字段
- 处理基因型和样本
- 创建和写入VCF文件
- 过滤和子集变体
- 多样本VCF操作

### 3. 序列文件操作（FASTA/FASTQ）

使用 `FastaFile` 随机访问参考序列，使用 `FastxFile` 读取原始测序数据。这适用于提取基因序列、对照参考验证变体或处理原始读数。

**常用操作：**
- 通过基因组坐标查询参考序列
- 提取感兴趣的基因或区域的序列
- 读取带有质量分数的 FASTQ 文件
- 验证变异参考等位基因
- 计算序列统计量
- 按质量或长度过滤读数
- FASTA 和 FASTQ 格式之间转换

**参考：** 请参阅 `references/sequence_files.md` 了解有关以下内容的详细文档：
- FASTA 文件访问和索引
- 按区域提取序列
- 处理基因的反向互补
- 顺序读取FASTQ文件
- 质量分数转换和过滤
- 使用 tabix 索引文件（BED、GTF、GFF）
- 常见的序列处理模式

### 4. 集成生物信息学工作流程

Pysam 擅长集成多种文件类型以进行全面的基因组分析。常见的工作流程结合了比对文件、变体文件和参考序列。

**常见工作流程：**
- 计算特定区域的覆盖统计数据
- 根据对齐读取验证变体
- 用覆盖率信息注释变体
- 提取变异位置周围的序列
- 根据多个标准过滤对齐或变体
- 生成覆盖轨迹以进行可视化
- 跨多种数据类型的质量控制
**参考：** 请参阅 `references/common_workflows.md` 了解详细示例：
- 质量控制工作流程（BAM统计、参考一致性）
- 覆盖率分析（每个碱基覆盖率、低覆盖率检测）
- 变异分析（注释、通过读取支持进行过滤）
- 序列提取（变异背景、基因序列）
- 读取过滤和子集
- 集成模式（BAM+VCF、VCF+BED等）
- 复杂工作流程的性能优化

## 关键概念

### 坐标系

**关键：** Pysam 使用 **基于 0 的半开**坐标（Python 约定）：
- 起始位置从 0 开始（第一个碱基是位置 0）
- 结束位置是排他性的（不包括在范围内）
- 区域 1000-2000 包括基地 1000-1999（总共 1000 个基地）

**例外：** `fetch()` 中的区域字符串遵循 samtools 约定（从 1 开始）：
<<<代码块_4>>>

**VCF 文件：** 在文件格式中使用从 1 开始的坐标，但 `VariantRecord.start` 是从 0 开始的。

### 索引要求

随机访问特定基因组区域需要索引文件：
- **BAM 文件**：需要 `.bai` 索引（使用 `pysam.index()` 创建）
- **CRAM 文件**：需要 `.crai` 索引
- **FASTA 文件**：需要 `.fai` 索引（使用 `pysam.faidx()` 创建）
- **VCF.gz 文件**：需要 `.tbi` tabix 索引（使用 `pysam.tabix_index()` 创建）
- **BCF 文件**：需要 `.csi` 索引

如果没有索引，请使用 `fetch(until_eof=True)` 进行顺序读取。

### 文件模式

打开文件时指定格式：
- `"rb"` - 读取 BAM（二进制）
- `"r"` - 读取 SAM（文本）
- `"rc"` - 读取 CRAM
- `"wb"` - 写入 BAM
- `"w"` - 写入 SAM
- `"wc"` - 写入 CRAM

### 性能考虑因素

1. **始终使用索引文件**进行随机访问操作
2. **使用`pileup()`进行按列分析**而不是重复的获取操作
3. **使用`count()`进行计数**而不是手动迭代计数
4. **分析独立基因组区域时并行处理区域**
5. **明确关闭文件**以释放资源
6. **使用`until_eof=True`**进行无索引的顺序处理
7. **除非必要，否则避免使用多个迭代器**（如果需要，请使用 `multiple_iterators=True`）

## 常见陷阱

1. **坐标混淆：** 记住不同上下文中基于 0 的系统与基于 1 的系统
2. **缺少索引：** 许多操作需要索引文件——首先创建它们
3. **部分重叠：** `fetch()` 返回读取重叠区域边界，而不仅仅是那些完全包含的区域边界
4. **迭代器作用域：** 保持堆积迭代器引用处于活动状态，以避免“迭代器完成后访问 PileupProxy”错误
5. **质量得分编辑：** 更改`query_sequence`后无法就地修改`query_qualities`——先创建一个副本
6. **流限制：** 仅支持 stdin/stdout 进行流处理，而不支持任意 Python 文件对象
7. **线程安全：** 虽然GIL在I/O期间被释放，但全面的线程安全性尚未得到充分验证

## 命令行工具

Pysam 提供对 samtools 和 bcftools 命令的访问：

<<<代码块_5>>>

**错误处理：**
<<<代码块_6>>>

## 资源

###参考资料/

每个主要功能的详细文档：

- **alignment_files.md** - SAM/BAM/CRAM 操作的完整指南，包括 AlignmentFile 类、AlignedSegment 属性、获取操作、堆积分析和写入对齐

- **variant_files.md** - VCF/BCF 操作的完整指南，包括 VariantFile 类、VariantRecord 属性、基因型处理、INFO/FORMAT 字段和多样本操作

- **sequence_files.md** - FASTA/FASTQ 操作的完整指南，包括 FastaFile 和 FastxFile 类、序列提取、质量分数处理和 tabix 索引文件访问

- **common_workflows.md** - 结合多种文件类型的集成生物信息学工作流程的实际示例，包括质量控制、覆盖率分析、变异验证和序列提取

## 获取帮助

具体操作的详细信息可以参考相应的参考文档：

- 使用 BAM 文件或计算覆盖率 → `alignment_files.md`
- 分析变异或基因型 → `variant_files.md`
- 提取序列或处理 FASTQ → `sequence_files.md`
- 集成多种文件类型的复杂工作流程 → `common_workflows.md`
官方文档：https://pysam.readthedocs.io/